<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Administrar productos - TiendaE</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-light min-vh-100 py-4">
  <div id="productosLogin" class="container">
    <a href="index.html" class="d-inline-block mb-3 text-primary fw-semibold text-decoration-none">← Volver a la tienda</a>
    <div class="row justify-content-center">
      <div class="col-12 col-sm-10 col-md-5 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body p-4">
            <h1 class="h5 fw-bold mb-4">Administrar productos</h1>
            <p class="text-muted small mb-3">Solo usuarios de staff pueden ingresar. Los compradores deben usar la tienda. Usuario staff: ej. admin@tiendae.com</p>
            <form id="formProductosLogin">
              <div class="mb-3">
                <label class="form-label">Usuario (email)</label>
                <input type="text" name="usuario" class="form-control" required autocomplete="username" placeholder="admin@tiendae.com">
              </div>
              <div class="mb-3">
                <label class="form-label">Clave</label>
                <div class="input-group">
                  <input type="password" name="clave" class="form-control" required autocomplete="current-password" id="adminProductosClave">
                  <button type="button" class="btn btn-outline-secondary" aria-label="Mostrar contraseña" onclick="var i=document.getElementById('adminProductosClave'); i.type=i.type==='password'?'text':'password'; this.textContent=i.type==='password'?'Ver':'Ocultar'; this.setAttribute('aria-label', i.type==='password'?'Mostrar contraseña':'Ocultar contraseña');">Ver</button>
                </div>
              </div>
              <button type="submit" class="btn btn-primary w-100">Entrar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="productosPanel" class="container d-none">
    <a href="index.html" class="d-inline-block mb-3 text-primary fw-semibold text-decoration-none">← Volver a la tienda</a>
    <a href="staff.html" class="d-inline-block mb-2 ms-2 text-secondary small text-decoration-none">Panel pedidos</a>
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
      <h1 class="h5 fw-bold mb-0">Administrar productos</h1>
      <button type="button" class="btn btn-outline-secondary btn-sm" id="btnProductosLogout">Cerrar sesión</button>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h6 fw-bold mb-3" id="formTitle">Nuevo producto</h2>
        <p class="text-muted small mb-3">Productos que agregues aquí se suman al catálogo cargado desde la otra página. Pueden ser celulares, electros o lo que necesites.</p>
        <form id="formProducto">
          <input type="hidden" name="id" id="productoId" value="">
          <div class="row g-2 g-md-3">
            <div class="col-12 col-md-4">
              <label class="form-label small">Código</label>
              <input type="text" name="codigo" class="form-control form-control-sm" required placeholder="ej. PROD-001">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label small">Nombre</label>
              <input type="text" name="nombre" class="form-control form-control-sm" required placeholder="Nombre del producto">
            </div>
            <div class="col-12 col-md-4">
              <label class="form-label small">Precio (ARS)</label>
              <input type="number" name="precio" class="form-control form-control-sm" required min="0" placeholder="0">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label small">Categoría</label>
              <select name="categoria_id" class="form-select form-select-sm" required id="selectCategoria">
                <option value="">Seleccionar...</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label small">Descripción</label>
              <textarea name="descripcion" class="form-control form-control-sm" rows="2" placeholder="Opcional"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label small">Fotos (varias)</label>
              <input type="file" name="fotos" class="form-control form-control-sm" accept="image/jpeg,image/png,image/gif,image/webp" multiple>
              <small class="text-muted">Solo al crear. JPG, PNG, GIF, WebP. Máx. 5 MB c/u.</small>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary btn-sm" id="btnSubmitProducto">Guardar</button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="btnCancelEdit">Cancelar</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="mb-2">
      <label class="form-check-label small">
        <input type="checkbox" class="form-check-input" id="incluirEliminados"> Incluir productos eliminados
      </label>
    </div>
    <div id="productosList" class="list-group"></div>
  </div>

  <div id="toastContainerAdmin" class="toast-container-tiendae" style="top:1rem;right:1rem;z-index:9999;"></div>
  <div class="modal fade" id="modalConfirm" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="modalConfirmBody">¿Eliminar este producto?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" id="modalConfirmOk">Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    var basePath = (window.location.pathname.indexOf('/tienda') === 0) ? '/tienda' : '';
    var API = basePath + '/api';
    var TOKEN_KEY = 'adminProductosToken';
    var token = localStorage.getItem(TOKEN_KEY);
    var categorias = [];

    function showToast(message, type) {
      type = type || 'success';
      var container = document.getElementById('toastContainerAdmin');
      if (!container) return;
      var icons = { success: '✓', error: '✕', info: 'ℹ' };
      var el = document.createElement('div');
      el.className = 'toast-tiendae ' + type;
      el.setAttribute('role', 'alert');
      el.innerHTML = '<span class="toast-icon">' + (icons[type] || '') + '</span><span>' + String(message).replace(/</g, '&lt;') + '</span>';
      container.appendChild(el);
      setTimeout(function () {
        el.style.opacity = '0';
        el.style.transform = 'translateX(1rem)';
        el.style.transition = 'opacity 0.25s, transform 0.25s';
        setTimeout(function () { if (el.parentNode) el.parentNode.removeChild(el); }, 280);
      }, 3200);
    }
    function showConfirm(message, onConfirm) {
      var body = document.getElementById('modalConfirmBody');
      var btn = document.getElementById('modalConfirmOk');
      var modal = new bootstrap.Modal(document.getElementById('modalConfirm'));
      if (body) body.textContent = message;
      var handler = function () {
        btn.removeEventListener('click', handler);
        modal.hide();
        if (typeof onConfirm === 'function') onConfirm();
      };
      btn.addEventListener('click', handler);
      modal.show();
    }

    function authHeaders() { return token ? { Authorization: 'Bearer ' + token } : {}; }

    function showViews() {
      var loginEl = document.getElementById('productosLogin');
      var panelEl = document.getElementById('productosPanel');
      if (token) {
        loginEl.classList.add('d-none');
        panelEl.classList.remove('d-none');
        loadCategorias().then(loadProductos);
      } else {
        loginEl.classList.remove('d-none');
        panelEl.classList.add('d-none');
      }
    }

    async function loadCategorias() {
      var res = await fetch(API + '/categorias');
      if (!res.ok) return;
      categorias = await res.json();
      var sel = document.getElementById('selectCategoria');
      sel.innerHTML = '<option value="">Seleccionar...</option>' + categorias.map(function (c) {
        return '<option value="' + c.id + '">' + (c.nombre || '') + '</option>';
      }).join('');
    }

    function formatPrice(n) {
      return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(n);
    }

    async function loadProductos() {
      var incluir = document.getElementById('incluirEliminados') && document.getElementById('incluirEliminados').checked;
      var url = API + '/admin/productos' + (incluir ? '?eliminados=1' : '');
      var res = await fetch(url, { headers: authHeaders() });
      if (res.status === 401) {
        token = null;
        localStorage.removeItem(TOKEN_KEY);
        showViews();
        return;
      }
      if (!res.ok) {
        document.getElementById('productosList').innerHTML = '<p class="text-danger">Error al cargar productos.</p>';
        return;
      }
      var list = await res.json();
      var el = document.getElementById('productosList');
      if (list.length === 0) {
        el.innerHTML = '<p class="text-muted">No hay productos cargados desde este panel. Agregá uno con el formulario de arriba.</p>';
        return;
      }
      el.innerHTML = list.map(function (p) {
        var eliminado = !!p.deleted_at;
        var img = (p.imagenes && p.imagenes[0] && p.imagenes[0].ruta) ? p.imagenes[0].ruta : '';
        var imgHtml = img ? '<div class="img-load-wrap img-thumb img-thumb-sm rounded me-2' + (eliminado ? ' opacity-75' : '') + '"><div class="img-load-spinner" aria-hidden="true"></div><img src="' + img.replace(/"/g, '&quot;') + '" alt="" class="rounded" onload="this.parentElement.classList.add(\'loaded\')" onerror="this.parentElement.classList.add(\'loaded\')"></div>' : '';
        var badgeEliminado = eliminado ? ' <span class="badge bg-danger">Eliminado</span>' : '';
        var acciones = eliminado
          ? '<button type="button" class="btn btn-outline-success btn-sm btn-restore" data-id="' + p.id + '">Restaurar</button>'
          : '<button type="button" class="btn btn-outline-primary btn-sm btn-edit" data-id="' + p.id + '">Editar</button>' +
            '<button type="button" class="btn btn-outline-danger btn-sm btn-delete" data-id="' + p.id + '">Eliminar</button>';
        return '<div class="list-group-item d-flex align-items-center flex-wrap gap-2' + (eliminado ? ' bg-light' : '') + '" data-id="' + p.id + '">' +
          imgHtml +
          '<div class="flex-grow-1 min-width-0">' +
            '<strong>' + (p.nombre || '') + '</strong> ' +
            '<span class="text-muted small">' + p.codigo + '</span> — ' + formatPrice(p.precio) +
            (p.categoria_nombre ? ' <span class="badge bg-secondary">' + p.categoria_nombre + '</span>' : '') +
            badgeEliminado +
          '</div>' +
          '<div class="d-flex gap-1">' + acciones + '</div></div>';
      }).join('');

      el.querySelectorAll('.btn-edit').forEach(function (btn) {
        btn.addEventListener('click', function () { editProducto(btn.dataset.id); });
      });
      el.querySelectorAll('.btn-delete').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var id = btn.dataset.id;
          showConfirm('Se ocultará del catálogo (borrado lógico). Podés restaurarlo después desde "Incluir productos eliminados".', function () { deleteProducto(id); });
        });
      });
      el.querySelectorAll('.btn-restore').forEach(function (btn) {
        btn.addEventListener('click', function () { restoreProducto(btn.dataset.id); });
      });
    }

    async function restoreProducto(id) {
      var res = await fetch(API + '/admin/productos/' + id + '/restore', { method: 'PATCH', headers: authHeaders() });
      if (res.status === 401) { token = null; localStorage.removeItem(TOKEN_KEY); showViews(); return; }
      if (res.ok) { showToast('Producto restaurado.'); loadProductos(); }
      else showToast('Error al restaurar.', 'error');
    }

    async function editProducto(id) {
      var res = await fetch(API + '/admin/productos/' + id, { headers: authHeaders() });
      if (!res.ok) return;
      var p = await res.json();
      document.getElementById('formTitle').textContent = 'Editar producto';
      document.getElementById('productoId').value = p.id;
      document.querySelector('[name="codigo"]').value = p.codigo || '';
      document.querySelector('[name="nombre"]').value = p.nombre || '';
      document.querySelector('[name="precio"]').value = p.precio || '';
      document.querySelector('[name="descripcion"]').value = p.descripcion || '';
      document.querySelector('[name="categoria_id"]').value = p.categoria_id || '';
      document.querySelector('[name="fotos"]').value = '';
      document.getElementById('btnSubmitProducto').textContent = 'Actualizar';
      document.getElementById('formProducto').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
      document.getElementById('formTitle').textContent = 'Nuevo producto';
      document.getElementById('productoId').value = '';
      document.getElementById('formProducto').reset();
      if (categorias.length) document.getElementById('selectCategoria').innerHTML = '<option value="">Seleccionar...</option>' + categorias.map(function (c) { return '<option value="' + c.id + '">' + (c.nombre || '') + '</option>'; }).join('');
      document.getElementById('btnSubmitProducto').textContent = 'Guardar';
    }

    async function deleteProducto(id) {
      var res = await fetch(API + '/admin/productos/' + id, { method: 'DELETE', headers: authHeaders() });
      if (res.status === 401) { token = null; localStorage.removeItem(TOKEN_KEY); showViews(); return; }
      if (res.ok) { loadProductos(); showToast('Producto eliminado.'); }
      else showToast('Error al eliminar. Intentá de nuevo.', 'error');
    }

    document.getElementById('formProductosLogin').addEventListener('submit', async function (e) {
      e.preventDefault();
      var form = e.target;
      var usuario = (form.querySelector('[name="usuario"]').value || '').trim();
      var clave = form.querySelector('[name="clave"]').value;
      var res = await fetch(API + '/staff/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: usuario, password: clave })
      });
      var data = await res.json().catch(function () { return {}; });
      if (!res.ok) {
        showToast(data.error || 'Usuario o clave incorrectos.', 'error');
        return;
      }
      token = data.token;
      localStorage.setItem(TOKEN_KEY, token);
      showViews();
    });

    document.getElementById('btnProductosLogout').addEventListener('click', function () {
      token = null;
      localStorage.removeItem(TOKEN_KEY);
      showViews();
    });

    document.getElementById('btnCancelEdit').addEventListener('click', cancelEdit);

    document.getElementById('formProducto').addEventListener('submit', async function (e) {
      e.preventDefault();
      var form = e.target;
      var id = (form.querySelector('#productoId').value || '').trim();
      var codigo = (form.querySelector('[name="codigo"]').value || '').trim();
      var nombre = (form.querySelector('[name="nombre"]').value || '').trim();
      var precio = parseInt(form.querySelector('[name="precio"]').value, 10);
      var descripcion = (form.querySelector('[name="descripcion"]').value || '').trim() || null;
      var categoria_id = parseInt(form.querySelector('[name="categoria_id"]').value, 10);
      var fileInput = form.querySelector('[name="fotos"]');

      if (!codigo || !nombre || !Number.isFinite(precio) || precio < 0 || !Number.isFinite(categoria_id) || categoria_id < 1) {
        showToast('Completá código, nombre, precio y categoría.', 'error');
        return;
      }

      if (id) {
        var res = await fetch(API + '/admin/productos/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ codigo: codigo, nombre: nombre, precio: precio, descripcion: descripcion, categoria_id: categoria_id })
        });
        if (res.status === 401) { token = null; localStorage.removeItem(TOKEN_KEY); showViews(); return; }
        if (!res.ok) { var d = await res.json().catch(function(){}); showToast(d.error || 'Error al actualizar.', 'error'); return; }
        showToast('Producto actualizado.');
        cancelEdit();
        loadProductos();
        return;
      }

      var fd = new FormData();
      fd.append('codigo', codigo);
      fd.append('nombre', nombre);
      fd.append('precio', String(precio));
      fd.append('descripcion', descripcion || '');
      fd.append('categoria_id', String(categoria_id));
      var files = fileInput.files || [];
      for (var i = 0; i < files.length; i++) fd.append('fotos', files[i]);

      var res = await fetch(API + '/admin/productos', {
        method: 'POST',
        headers: authHeaders(),
        body: fd
      });
      if (res.status === 401) { token = null; localStorage.removeItem(TOKEN_KEY); showViews(); return; }
      if (!res.ok) { var d = await res.json().catch(function(){}); showToast(d.error || 'Error al crear.', 'error'); return; }
      showToast('Producto creado.');
      form.reset();
      if (categorias.length) document.getElementById('selectCategoria').innerHTML = '<option value="">Seleccionar...</option>' + categorias.map(function (c) { return '<option value="' + c.id + '">' + (c.nombre || '') + '</option>'; }).join('');
      loadProductos();
    });

    document.getElementById('incluirEliminados') && document.getElementById('incluirEliminados').addEventListener('change', loadProductos);

    showViews();
  </script>
</body>
</html>
